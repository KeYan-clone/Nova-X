# Monitor Service - ç»Ÿä¸€å¯è§‚æµ‹æ€§å¹³å°

## æœåŠ¡ç®€ä»‹

ç›‘æ§æœåŠ¡æ˜¯ Nova-X å……ç”µæ¡©ç®¡ç†å¹³å°çš„ç»Ÿä¸€å¯è§‚æµ‹æ€§å¹³å°ï¼Œæ•´åˆäº†**æŒ‡æ ‡ç›‘æ§**ã€**æ—¥å¿—èšåˆ**å’Œ**é“¾è·¯è¿½è¸ª**ä¸‰å¤§æ ¸å¿ƒåŠŸèƒ½ï¼Œä¸ºç³»ç»Ÿæä¾›å…¨æ–¹ä½çš„ç›‘æ§å’Œåˆ†æèƒ½åŠ›ã€‚

### æ ¸å¿ƒä»·å€¼
- ğŸ” **å…¨é“¾è·¯å¯è§‚æµ‹** - TraceId è´¯ç©¿æ•´ä¸ªè°ƒç”¨é“¾ï¼Œå¿«é€Ÿå®šä½é—®é¢˜
- ğŸ“Š **å®æ—¶æŒ‡æ ‡ç›‘æ§** - åŸºäº Prometheus + Grafana çš„å®æ—¶ç›‘æ§
- ğŸ“ **é›†ä¸­å¼æ—¥å¿—** - ELK Stack æä¾›å¼ºå¤§çš„æ—¥å¿—æ£€ç´¢èƒ½åŠ›
- ğŸš¨ **æ™ºèƒ½å‘Šè­¦** - å¤šç»´åº¦å‘Šè­¦è§„åˆ™ï¼Œç¬¬ä¸€æ—¶é—´å‘ç°å¼‚å¸¸
- ğŸ“ˆ **æ€§èƒ½åˆ†æ** - æ·±å…¥åˆ†æç³»ç»Ÿç“¶é¢ˆï¼ŒæŒç»­ä¼˜åŒ–æ€§èƒ½

## æ ¸å¿ƒåŠŸèƒ½

### 1. æŒ‡æ ‡ç›‘æ§ï¼ˆMetricsï¼‰
åŸºäº **Prometheus + Grafana** å®ç°

**ç³»ç»ŸæŒ‡æ ‡**
- CPUä½¿ç”¨ç‡ã€å†…å­˜ä½¿ç”¨ç‡ã€ç£ç›˜IOã€ç½‘ç»œæµé‡
- çº¿ç¨‹æ•°ã€æ–‡ä»¶å¥æŸ„æ•°ã€ç½‘ç»œè¿æ¥æ•°

**JVMæŒ‡æ ‡**
- å †å†…å­˜ä½¿ç”¨é‡ã€éå †å†…å­˜ä½¿ç”¨é‡
- GCæ¬¡æ•°ã€GCè€—æ—¶ã€GCç±»å‹
- çº¿ç¨‹çŠ¶æ€åˆ†å¸ƒã€æ­»é”æ£€æµ‹

**åº”ç”¨æŒ‡æ ‡**
- QPS/TPSï¼ˆæ¯ç§’è¯·æ±‚æ•°/äº‹åŠ¡æ•°ï¼‰
- å“åº”æ—¶é—´ï¼ˆP50/P95/P99ï¼‰
- é”™è¯¯ç‡ã€æˆåŠŸç‡
- æ¥å£è°ƒç”¨ç»Ÿè®¡

**ä¸šåŠ¡æŒ‡æ ‡**
- å……ç”µè®¢å•æ•°ã€è¥æ”¶ç»Ÿè®¡
- è®¾å¤‡åœ¨çº¿ç‡ã€æ•…éšœç‡
- ç”¨æˆ·æ´»è·ƒåº¦ã€è½¬åŒ–ç‡

### 2. æ—¥å¿—èšåˆï¼ˆLoggingï¼‰
åŸºäº **ELK Stack** (Elasticsearch + Logstash + Kibana)

**æ—¥å¿—é‡‡é›†**
- common-log åœ¨åº”ç”¨ä¾§ç”Ÿæˆ TraceId
- æœ¬åœ°æ—¥å¿—æ–‡ä»¶ï¼š/var/log/nova-x/{service}/
- Filebeat é‡‡é›†å¹¶æ¨é€åˆ° Kafka/Logstash

**æ—¥å¿—å­˜å‚¨**
- Elasticsearch å…¨æ–‡ç´¢å¼•
- æ”¯æŒæŒ‰æœåŠ¡ã€çº§åˆ«ã€TraceIdã€å…³é”®è¯æŸ¥è¯¢
- æ—¥å¿—å½’æ¡£å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†

**æ—¥å¿—åˆ†æ**
- å®æ—¶æ—¥å¿—æµ
- é”™è¯¯æ—¥å¿—ç»Ÿè®¡
- æ“ä½œå®¡è®¡æ—¥å¿—
- æ€§èƒ½æ—¥å¿—åˆ†æ

### 3. é“¾è·¯è¿½è¸ªï¼ˆTracingï¼‰
åŸºäº **TraceId** çš„åˆ†å¸ƒå¼è¿½è¸ª

**é“¾è·¯è·Ÿè¸ª**
- è¯·æ±‚å…¥å£ç”Ÿæˆå…¨å±€å”¯ä¸€ TraceId
- TraceId åœ¨å¾®æœåŠ¡é—´é€ä¼ 
- å®Œæ•´è¿˜åŸè°ƒç”¨é“¾è·¯

**æ€§èƒ½åˆ†æ**
- è¯†åˆ«æ…¢æŸ¥è¯¢å’Œæ€§èƒ½ç“¶é¢ˆ
- æœåŠ¡ä¾èµ–å…³ç³»å›¾
- è°ƒç”¨æ—¶é•¿ç»Ÿè®¡

**å¼‚å¸¸å®šä½**
- æ ¹æ® TraceId å¿«é€Ÿå®šä½é”™è¯¯
- æŸ¥çœ‹å®Œæ•´è°ƒç”¨æ ˆ
- å…³è”æ—¥å¿—å’ŒæŒ‡æ ‡

## æŠ€æœ¯æ¶æ„

### æ•°æ®æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              åº”ç”¨å±‚ï¼ˆå„å¾®æœåŠ¡ï¼‰                            â”‚
â”‚  â”œâ”€ common-log: ç”Ÿæˆ TraceIdã€è®°å½•æ—¥å¿—                    â”‚
â”‚  â”œâ”€ Micrometer: æš´éœ² Prometheus æŒ‡æ ‡                      â”‚
â”‚  â””â”€ æœ¬åœ°æ—¥å¿—æ–‡ä»¶: /var/log/nova-x/                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    é‡‡é›†å±‚                                  â”‚
â”‚  â”œâ”€ Prometheus: å®šæ—¶æ‹‰å–æŒ‡æ ‡æ•°æ®                          â”‚
â”‚  â””â”€ Filebeat: é‡‡é›†æœ¬åœ°æ—¥å¿—æ–‡ä»¶                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¼ è¾“å±‚                                  â”‚
â”‚  â””â”€ Kafka/Logstash: ç¼“å†²å’Œè·¯ç”±                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å­˜å‚¨å±‚                                  â”‚
â”‚  â”œâ”€ Prometheus TSDB: æ—¶åºæŒ‡æ ‡å­˜å‚¨                         â”‚
â”‚  â””â”€ Elasticsearch: æ—¥å¿—å…¨æ–‡ç´¢å¼•                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            å±•ç¤ºå±‚ï¼ˆmonitor-service æä¾›ï¼‰                  â”‚
â”‚  â”œâ”€ Grafana: æŒ‡æ ‡å¯è§†åŒ–ä¸å‘Šè­¦                             â”‚
â”‚  â”œâ”€ Kibana: æ—¥å¿—æ£€ç´¢ä¸åˆ†æ                                â”‚
â”‚  â””â”€ API: å¯¹å¤–æä¾›æŸ¥è¯¢æ¥å£                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æŠ€æœ¯æ ˆ

| ç»„ä»¶            | ç‰ˆæœ¬  | è¯´æ˜                 |
| --------------- | ----- | -------------------- |
| Prometheus      | 2.45+ | æ—¶åºæ•°æ®åº“ã€æŒ‡æ ‡é‡‡é›† |
| Grafana         | 10.0+ | å¯è§†åŒ–å’Œå‘Šè­¦å¹³å°     |
| Elasticsearch   | 8.17+ | æ—¥å¿—å­˜å‚¨å’Œå…¨æ–‡æ£€ç´¢   |
| Logstash        | 8.17+ | æ—¥å¿—å¤„ç†ç®¡é“         |
| Kibana          | 8.17+ | æ—¥å¿—å¯è§†åŒ–å’Œåˆ†æ     |
| Filebeat        | 8.17+ | è½»é‡çº§æ—¥å¿—é‡‡é›†å™¨     |
| Kafka           | 3.9+  | æ¶ˆæ¯ç¼“å†²ï¼ˆå¯é€‰ï¼‰     |
| Micrometer      | 1.14+ | åº”ç”¨æŒ‡æ ‡é—¨é¢         |
| Spring Actuator | 3.5+  | å¥åº·æ£€æŸ¥å’ŒæŒ‡æ ‡æš´éœ²   |

## API æ¥å£

### å¥åº·æ£€æŸ¥ API

#### è·å–ç³»ç»Ÿæ¦‚è§ˆ
```http
GET /health/overview
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "totalServices": 15,
    "healthyServices": 14,
    "unhealthyServices": 1,
    "totalQps": 15000,
    "avgResponseTime": 85,
    "errorRate": 0.12,
    "todayTotalRequests": 1250000,
    "todayErrors": 1500,
    "serviceHealthList": [...]
  }
}
```

#### è·å–æ‰€æœ‰æœåŠ¡å¥åº·çŠ¶æ€
```http
GET /health/services
```

#### è·å–æŒ‡å®šæœåŠ¡å¥åº·çŠ¶æ€
```http
GET /health/services/{serviceName}
```

### æŒ‡æ ‡ç›‘æ§ API

#### è·å–æœåŠ¡æŒ‡æ ‡
```http
GET /metrics/services/{serviceName}
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "code": 200,
  "data": {
    "serviceName": "station-service",
    "qps": 150.50,
    "avgResponseTime": 85.50,
    "p95ResponseTime": 120,
    "p99ResponseTime": 250,
    "errorRate": 0.15,
    "successRate": 99.85,
    "cpuUsage": 45.5,
    "memoryUsage": 65.8,
    "heapMemoryUsed": 512.50,
    "heapMemoryMax": 1024.00,
    "gcCount": 125,
    "gcTime": 3500,
    "threadCount": 45
  }
}
```

#### è·å–æ‰€æœ‰æœåŠ¡æŒ‡æ ‡
```http
GET /metrics/services
```

#### æŸ¥è¯¢æŒ‡æ ‡å†å²
```http
GET /metrics/history?serviceName=station-service&metricName=qps&hours=24
```

### æ—¥å¿—æŸ¥è¯¢ API

#### æŸ¥è¯¢æ—¥å¿—
```http
POST /logs/query
Content-Type: application/json

{
  "serviceName": "station-service",
  "level": "ERROR",
  "keyword": "å……ç”µç«™",
  "startTime": "2026-01-25T00:00:00",
  "endTime": "2026-01-25T23:59:59",
  "page": 1,
  "size": 20
}
```

#### æ ¹æ® TraceId æŸ¥è¯¢é“¾è·¯æ—¥å¿—
```http
GET /logs/trace/{traceId}
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "code": 200,
  "data": [
    {
      "timestamp": "2026-01-25T10:30:25",
      "serviceName": "gateway-service",
      "level": "INFO",
      "traceId": "trace-1737781825000-1",
      "className": "com.novax.gateway.filter.AuthFilter",
      "message": "JWTè®¤è¯é€šè¿‡",
      "requestUri": "/api/v1/stations",
      "clientIp": "192.168.1.100"
    },
    {
      "timestamp": "2026-01-25T10:30:26",
      "serviceName": "station-service",
      "level": "INFO",
      "traceId": "trace-1737781825000-1",
      "className": "com.novax.station.service.StationService",
      "message": "æŸ¥è¯¢é™„è¿‘å……ç”µç«™",
      "requestUri": "/stations/nearby"
    }
  ]
}
```

#### ç»Ÿè®¡é”™è¯¯æ—¥å¿—æ•°é‡
```http
GET /logs/errors/count?serviceName=station-service&hours=24
```

## éƒ¨ç½²è¿è¡Œ

### ç¯å¢ƒè¦æ±‚
- JDK 21+
- Nacos 2.3+
- Prometheus 2.45+ (å¯é€‰ï¼Œç”¨äºç”Ÿäº§ç¯å¢ƒ)
- Elasticsearch 8.17+ (å¯é€‰ï¼Œç”¨äºç”Ÿäº§ç¯å¢ƒ)

### å¯åŠ¨æ­¥éª¤

#### 1. å¯åŠ¨ Nacos
```bash
cd nacos/bin
./startup.sh -m standalone
```

#### 2. å¯åŠ¨ç›‘æ§æœåŠ¡
```bash
cd backend/infrastructure/monitor-service
mvn spring-boot:run
```

#### 3. éªŒè¯æœåŠ¡
```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:8104/actuator/health

# Prometheus æŒ‡æ ‡
curl http://localhost:8104/actuator/prometheus

# ç³»ç»Ÿæ¦‚è§ˆ
curl http://localhost:8104/health/overview

# API æ–‡æ¡£
open http://localhost:8104/doc.html
```

### Docker éƒ¨ç½²ï¼ˆå¯é€‰ï¼‰

```bash
# æ„å»ºé•œåƒ
docker build -t novax/monitor-service:1.0.0 .

# è¿è¡Œå®¹å™¨
docker run -d \
  --name monitor-service \
  -p 8104:8104 \
  -e NACOS_SERVER=nacos:8848 \
  novax/monitor-service:1.0.0
```

## é…ç½®è¯´æ˜

### application.yml

```yaml
server:
  port: 8104

spring:
  application:
    name: monitor-service

# Actuator é…ç½®
management:
  endpoints:
    web:
      exposure:
        include: '*'
  endpoint:
    health:
      show-details: always
  metrics:
    export:
      prometheus:
        enabled: true

# Elasticsearch é…ç½®ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
elasticsearch:
  host: localhost
  port: 9200
  username: elastic
  password: changeme
```

### Prometheus é…ç½®

```yaml
# prometheus.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'nova-x-services'
    metrics_path: '/actuator/prometheus'
    static_configs:
      - targets:
        - 'gateway-service:9000'
        - 'auth-service:8080'
        - 'account-service:8081'
        - 'station-service:8082'
        - 'device-service:8083'
        - 'monitor-service:8104'
```

## ç›‘æ§æŒ‡æ ‡

### SLA æŒ‡æ ‡
- **å¯ç”¨æ€§** - ç›®æ ‡ 99.99%
- **å“åº”æ—¶é—´** - P95 < 100ms, P99 < 200ms
- **é”™è¯¯ç‡** - < 0.5%
- **QPS** - æ ¸å¿ƒé“¾è·¯ â‰¥ 50,000

### å‘Šè­¦è§„åˆ™

| çº§åˆ« | è§¦å‘æ¡ä»¶                         | é€šçŸ¥æ–¹å¼               | å“åº”æ—¶é—´ |
| ---- | -------------------------------- | ---------------------- | -------- |
| P0   | æœåŠ¡ä¸å¯ç”¨ã€æ ¸å¿ƒæ¥å£å¤±è´¥ç‡ > 10% | ç”µè¯ + çŸ­ä¿¡ + ä¼ä¸šå¾®ä¿¡ | 5 åˆ†é’Ÿ   |
| P1   | æ¥å£å“åº”è¶…æ—¶ã€æ•°æ®åº“è¿æ¥æ± è€—å°½   | çŸ­ä¿¡ + ä¼ä¸šå¾®ä¿¡        | 15 åˆ†é’Ÿ  |
| P2   | ç¼“å­˜å¤±æ•ˆã€MQ ç§¯å‹                | ä¼ä¸šå¾®ä¿¡ + é‚®ä»¶        | 30 åˆ†é’Ÿ  |
| P3   | èµ„æºä½¿ç”¨ç‡ > 80%                 | é‚®ä»¶                   | 1 å°æ—¶   |

## æœ€ä½³å®è·µ

### 1. æ—¥å¿—è§„èŒƒ
```java
// ä½¿ç”¨ @Log æ³¨è§£è®°å½•æ“ä½œæ—¥å¿—
@Log(value = "æŸ¥è¯¢å……ç”µç«™", type = Log.OperationType.SELECT)
public Result<List<StationVO>> queryStations(StationQueryDTO dto) {
    // ä¸šåŠ¡é€»è¾‘
}

// è®°å½•å…³é”®ä¸šåŠ¡æ—¥å¿—
log.info("ç”¨æˆ· {} å¼€å§‹å……ç”µï¼Œå……ç”µæ¡©: {}", userId, deviceId);
log.error("å……ç”µå¯åŠ¨å¤±è´¥ï¼ŒåŸå› : {}", e.getMessage(), e);
```

### 2. æŒ‡æ ‡åŸ‹ç‚¹
```java
// è‡ªå®šä¹‰ä¸šåŠ¡æŒ‡æ ‡
@Timed(value = "charging.start", description = "å……ç”µå¯åŠ¨è€—æ—¶")
public void startCharging(Long sessionId) {
    // ä¸šåŠ¡é€»è¾‘
}

// è®¡æ•°å™¨
Counter.builder("charging.sessions.total")
       .description("å……ç”µä¼šè¯æ€»æ•°")
       .register(meterRegistry)
       .increment();
```

### 3. é“¾è·¯è¿½è¸ª
- TraceId è‡ªåŠ¨ç”Ÿæˆå’Œä¼ é€’ï¼ˆcommon-log å·²å®ç°ï¼‰
- å…³é”®ä¸šåŠ¡èŠ‚ç‚¹è®°å½•æ—¥å¿—
- å¼‚å¸¸æ—¶è®°å½•å®Œæ•´å †æ ˆ

## åç»­ä¼˜åŒ–

1. **é›†æˆ SkyWalking** - æ›´å¼ºå¤§çš„é“¾è·¯è¿½è¸ªèƒ½åŠ›
2. **AI æ™ºèƒ½å‘Šè­¦** - åŸºäºå†å²æ•°æ®çš„æ™ºèƒ½é˜ˆå€¼
3. **è‡ªåŠ¨åŒ–åˆ†æ** - å¼‚å¸¸æ ¹å› åˆ†æ
4. **å®¹é‡é¢„æµ‹** - åŸºäºè¶‹åŠ¿çš„å®¹é‡è§„åˆ’
5. **æˆæœ¬ä¼˜åŒ–** - èµ„æºä½¿ç”¨æ•ˆç‡åˆ†æ

---

**æœåŠ¡ç«¯å£**: 8104
**æœåŠ¡å**: monitor-service
**è´Ÿè´£äºº**: Nova-X Team
**æ›´æ–°æ—¶é—´**: 2026-01-25
