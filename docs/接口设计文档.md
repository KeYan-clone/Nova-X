# Nova-X 接口设计文档（摘录）

## 1. 鉴权与安全
- 用户端：OAuth2/OIDC，JWT；管理端/BFF 强制 MFA。
- 设备侧：双向 TLS + 设备证书。
- 所有接口需要 x-trace-id；关键写接口要求签名（app_id, nonce, ts, sign），5 分钟窗口。
- 幂等：Header `Idempotency-Key`，服务端记录 24h 幂等表，返回首响应。

## 2. 通用规范
- 分页：page, page_size（最大 100），返回 total。
- 时间：ISO8601，UTC 存储；货币使用三字码，精度到分/分币。
- 错误码：0 成功；40001 参数错误；40003 未授权；40005 幂等冲突；40300 权限不足；40400 不存在；40900 业务冲突；42900 频率限制；50000 系统错误。

## 3. 典型 REST 接口示例
- 找桩：GET /api/v1/stations?lng=&lat=&radius=&power_type=&brand=&status=
- 启动充电：POST /api/v1/charging/sessions { connector_id, mode, preset_amount, idempotency_key }
- 充电状态：GET /api/v1/charging/sessions/{id}
- 结束充电：POST /api/v1/charging/sessions/{id}/stop { reason, idempotency_key }
- 支付回调：POST /api/v1/payments/callback/{channel}
- 账单查询：GET /api/v1/billing?from=&to=&page=&page_size=
- 站点管理：POST /api/v1/op/stations; PATCH /api/v1/op/stations/{id}
- 定价配置：POST /api/v1/op/pricing_rules; GET /api/v1/op/pricing_rules?station_id=
- DR 指令：POST /api/v1/utilities/dr_orders { region, power_limit, window, reason }
- 设备影子：GET /api/v1/iot/devices/{id}/shadow

## 4. 实时通道（WebSocket/SSE）
- 主题：charging_status_update、connector_status_change、price_update、alarm_event、dr_command。
- 鉴权：连接时携带 token；心跳/超时；服务端按租户/角色路由。

## 5. 版本与灰度
- Header: X-Version；API Gateway 进行版本路由。
- 新旧协议双栈，设定弃用日期；灰度与金丝雀发布。
