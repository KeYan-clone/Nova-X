# Nova-X 接口设计文档

## 1. 鉴权与安全
- 用户端：OAuth2/OIDC，JWT；管理端/BFF 强制 MFA。
- 设备侧：双向 TLS + 设备证书。
- 所有接口需要 x-trace-id；关键写接口要求签名（app_id, nonce, ts, sign），5 分钟窗口。
- 幂等：Header `Idempotency-Key`，服务端记录 24h 幂等表，返回首响应。

## 2. 通用规范
- 分页：page, page_size（最大 100），返回 total。
- 时间：ISO8601，UTC 存储；货币使用三字码，精度到分/分币。
- 错误码：0 成功；40001 参数错误；40003 未授权；40005 幂等冲突；40300 权限不足；40400 不存在；40900 业务冲突；42900 频率限制；50000 系统错误。

---

## 3. 基础设施服务接口

### 3.1 认证服务 (Auth Service)
**Base URL**: `/api/v1/auth`

| 方法 | 路径              | 说明           | 请求参数                                                   | 响应                                              |
| ---- | ----------------- | -------------- | ---------------------------------------------------------- | ------------------------------------------------- |
| POST | `/login/password` | 密码登录       | PasswordLoginDTO (username/phone/email, password, captcha) | LoginVO (access_token, refresh_token, expires_in) |
| POST | `/login/sms`      | 短信验证码登录 | SmsLoginDTO (phone, sms_code)                              | LoginVO                                           |
| POST | `/refresh`        | 刷新令牌       | Header: Refresh-Token                                      | LoginVO (新的 access_token)                       |
| POST | `/logout`         | 退出登录       | Header: Authorization                                      | void                                              |
| GET  | `/captcha`        | 获取图形验证码 | -                                                          | CaptchaVO (key, image_base64)                     |
| POST | `/sms-code`       | 发送短信验证码 | phone (手机号)                                             | void                                              |
| GET  | `/validate`       | 验证令牌有效性 | Header: Authorization                                      | Boolean                                           |

---

## 4. 核心业务服务接口

### 4.1 用户服务 (Account Service)
**Base URL**: `/api/v1/users`

| 方法  | 路径                | 说明               | 请求参数                                    | 响应               |
| ----- | ------------------- | ------------------ | ------------------------------------------- | ------------------ |
| POST  | `/register`         | 用户注册           | UserRegisterDTO (phone, password, sms_code) | userId             |
| GET   | `/{userId}`         | 获取用户信息       | userId                                      | UserVO             |
| GET   | `/phone/{phone}`    | 根据手机号获取用户 | phone                                       | UserVO             |
| PATCH | `/{userId}`         | 更新用户信息       | userId, UserVO                              | void               |
| POST  | `/{userId}/verify`  | 实名认证           | userId, realName, idCard                    | void               |
| GET   | -                   | 分页查询用户列表   | PageQuery (page, page_size)                 | PageResult<UserVO> |
| POST  | `/{userId}/disable` | 禁用用户           | userId                                      | void               |
| POST  | `/{userId}/enable`  | 启用用户           | userId                                      | void               |

### 4.2 充电站服务 (Station Service)
**Base URL**: `/stations`

| 方法  | 路径    | 说明           | 请求参数                                    | 响应          |
| ----- | ------- | -------------- | ------------------------------------------- | ------------- |
| POST  | -       | 创建充电站     | StationCreateDTO                            | Station       |
| GET   | `/{id}` | 获取充电站详情 | stationId                                   | Station       |
| PATCH | `/{id}` | 更新充电站信息 | stationId, StationUpdateDTO                 | Station       |
| GET   | -       | 查询充电站列表 | lng, lat, radius, power_type, brand, status | List<Station> |

### 4.3 设备服务 (Device Service)
**Base URL**: `/devices`

| 方法 | 路径                   | 说明                   | 请求参数          | 响应         |
| ---- | ---------------------- | ---------------------- | ----------------- | ------------ |
| GET  | -                      | 获取设备列表           | stationId, status | List<Device> |
| GET  | `/{id}/status`         | 获取设备状态           | deviceId          | DeviceStatus |
| POST | `/register`            | 注册设备               | DeviceRegisterDTO | Device       |
| GET  | `/station/{stationId}` | 获取充电站下的所有设备 | stationId         | List<Device> |

### 4.4 充电会话服务 (Session Service)
**说明**: session-service 尚未实现完整的 Controller，基于文档推断以下接口

**Base URL**: `/api/v1/charging/sessions`

| 方法 | 路径             | 说明             | 请求参数                                               | 响应                        |
| ---- | ---------------- | ---------------- | ------------------------------------------------------ | --------------------------- |
| POST | -                | 启动充电         | { connector_id, mode, preset_amount, idempotency_key } | ChargingSession             |
| GET  | `/{id}`          | 获取充电状态     | sessionId                                              | ChargingSession             |
| POST | `/{id}/stop`     | 结束充电         | sessionId, { reason, idempotency_key }                 | ChargingSession             |
| GET  | `/user/{userId}` | 获取用户充电历史 | userId, page, page_size                                | PageResult<ChargingSession> |

### 4.5 账单服务 (Billing Service)
**Base URL**: `/bills`

| 方法 | 路径                    | 说明             | 请求参数                                                 | 响应         |
| ---- | ----------------------- | ---------------- | -------------------------------------------------------- | ------------ |
| POST | `/generate/{sessionId}` | 根据会话生成账单 | sessionId                                                | Bill         |
| GET  | `/{id}`                 | 根据ID查询账单   | billId                                                   | BillVO       |
| GET  | `/no/{billNo}`          | 根据账单编号查询 | billNo                                                   | BillVO       |
| POST | `/query`                | 分页查询账单     | BillQueryDTO (from, to, userId, status, page, page_size) | Page<BillVO> |
| POST | `/{id}/pay`             | 支付账单         | billId, paymentMethod, transactionNo                     | Boolean      |
| POST | `/{id}/cancel`          | 取消账单         | billId                                                   | Boolean      |
| POST | `/{id}/refund`          | 退款             | billId                                                   | Boolean      |

### 4.6 支付服务 (Payment Service)
**Base URL**: `/payments`

| 方法 | 路径                  | 说明         | 请求参数                                                    | 响应                               |
| ---- | --------------------- | ------------ | ----------------------------------------------------------- | ---------------------------------- |
| POST | `/create`             | 创建支付     | PaymentCreateDTO (billNo, amount, paymentMethod, returnUrl) | PaymentResultVO (pay_url, qr_code) |
| GET  | `/{paymentNo}`        | 查询支付结果 | paymentNo                                                   | PaymentResultVO                    |
| POST | `/{paymentNo}/close`  | 关闭支付     | paymentNo                                                   | Boolean                            |
| POST | `/refund`             | 申请退款     | RefundApplyDTO (paymentNo, refundAmount, reason)            | Boolean                            |
| GET  | `/refund/{refundNo}`  | 查询退款结果 | refundNo                                                    | RefundVO                           |
| POST | `/callback/{channel}` | 支付回调     | channel (alipay/wechat/unionpay), 回调参数                  | void                               |

### 4.7 会员服务 (Member Service)
**Base URL**: `/members`

| 方法 | 路径                | 说明         | 请求参数                                    | 响应                                  |
| ---- | ------------------- | ------------ | ------------------------------------------- | ------------------------------------- |
| POST | `/open`             | 开通会员     | userId                                      | MemberInfoVO                          |
| GET  | `/user/{userId}`    | 查询会员信息 | userId                                      | MemberInfoVO (balance, points, level) |
| POST | `/recharge`         | 余额充值     | userId, RechargeDTO (amount, paymentMethod) | Boolean                               |
| GET  | `/points/{userId}`  | 查询积分余额 | userId                                      | Integer                               |
| GET  | `/balance/{userId}` | 查询账户余额 | userId                                      | BigDecimal                            |

### 4.8 定价服务 (Pricing Service)
**说明**: pricing-service 尚未实现完整的 Controller，基于文档推断以下接口

**Base URL**: `/api/v1/op/pricing_rules`

| 方法   | 路径             | 说明         | 请求参数                           | 响应              |
| ------ | ---------------- | ------------ | ---------------------------------- | ----------------- |
| POST   | -                | 创建定价规则 | PricingRuleDTO                     | PricingRule       |
| GET    | -                | 查询定价规则 | station_id, region, effective_date | List<PricingRule> |
| PATCH  | `/{id}`          | 更新定价规则 | ruleId, PricingRuleDTO             | PricingRule       |
| DELETE | `/{id}`          | 删除定价规则 | ruleId                             | void              |
| POST   | `/{id}/activate` | 激活定价规则 | ruleId                             | void              |

---

## 5. 高级功能服务接口

### 5.1 调度服务 (Scheduling Service)
**Base URL**: `/scheduling`

| 方法 | 路径                                   | 说明             | 请求参数                                                       | 响应                      |
| ---- | -------------------------------------- | ---------------- | -------------------------------------------------------------- | ------------------------- |
| GET  | `/available-devices`                   | 查询可用设备     | stationId, startTime, endTime                                  | List<AvailableDeviceVO>   |
| POST | `/reservations`                        | 创建预约         | CreateReservationDTO (userId, connectorId, startTime, endTime) | ChargingReservation       |
| POST | `/reservations/{reservationId}/cancel` | 取消预约         | reservationId, reason                                          | Boolean                   |
| GET  | `/reservations/user/{userId}`          | 获取用户预约列表 | userId                                                         | List<ChargingReservation> |
| GET  | `/reservations/{reservationId}`        | 查询预约详情     | reservationId                                                  | ChargingReservation       |

### 5.2 需求响应/VPP 服务 (DR-VPP Service)
**Base URL**: `/dr-vpp`

| 方法 | 路径                         | 说明             | 请求参数                                                           | 响应                      |
| ---- | ---------------------------- | ---------------- | ------------------------------------------------------------------ | ------------------------- |
| POST | `/events`                    | 创建需求响应事件 | CreateEventDTO (region, power_limit, start_time, end_time, reason) | DemandResponseEvent       |
| POST | `/events/{eventId}/start`    | 启动事件         | eventId                                                            | Boolean                   |
| POST | `/events/{eventId}/complete` | 完成事件         | eventId                                                            | Boolean                   |
| GET  | `/devices/available`         | 查询可用设备     | -                                                                  | List<VppDevice>           |
| GET  | `/events/active`             | 查询进行中的事件 | -                                                                  | List<DemandResponseEvent> |
| GET  | `/events/{eventId}`          | 查询事件详情     | eventId                                                            | DemandResponseEvent       |

### 5.3 结算服务 (Settlement Service)
**Base URL**: `/settlements`

| 方法 | 路径                      | 说明           | 请求参数                                        | 响应                  |
| ---- | ------------------------- | -------------- | ----------------------------------------------- | --------------------- |
| POST | -                         | 创建结算单     | CreateSettlementDTO (operatorId, period, bills) | SettlementOrder       |
| POST | `/{settlementId}/confirm` | 确认结算单     | settlementId                                    | Boolean               |
| POST | `/{settlementId}/pay`     | 支付结算单     | settlementId                                    | Boolean               |
| GET  | `/{settlementId}`         | 查询结算单详情 | settlementId                                    | SettlementOrder       |
| GET  | `/pending`                | 获取待结算列表 | -                                               | List<SettlementOrder> |

### 5.4 工单服务 (Work Order Service)
**Base URL**: `/work-orders`

| 方法 | 路径                  | 说明           | 请求参数                                                         | 响应            |
| ---- | --------------------- | -------------- | ---------------------------------------------------------------- | --------------- |
| POST | -                     | 创建工单       | CreateWorkOrderDTO (stationId, deviceId, orderType, description) | WorkOrder       |
| POST | `/{orderId}/assign`   | 分配工单       | orderId, handlerId                                               | Boolean         |
| POST | `/{orderId}/start`    | 开始处理       | orderId                                                          | Boolean         |
| POST | `/{orderId}/complete` | 完成工单       | orderId, handleResult                                            | Boolean         |
| GET  | `/{orderId}`          | 查询工单详情   | orderId                                                          | WorkOrder       |
| GET  | `/pending`            | 获取待处理工单 | -                                                                | List<WorkOrder> |
| GET  | `/my/{handlerId}`     | 获取我的工单   | handlerId                                                        | List<WorkOrder> |

### 5.5 通知服务 (Notification Service)
**Base URL**: `/notifications`

| 方法 | 路径                | 说明         | 请求参数                                                     | 响应                      |
| ---- | ------------------- | ------------ | ------------------------------------------------------------ | ------------------------- |
| POST | `/send`             | 发送通知     | SendNotificationDTO (userId, type, title, content, channels) | Boolean                   |
| GET  | `/unread/{userId}`  | 获取未读消息 | userId                                                       | List<NotificationMessage> |
| POST | `/{messageId}/read` | 标记为已读   | messageId                                                    | Boolean                   |

### 5.6 报表服务 (Report Service)
**Base URL**: `/reports`

| 方法 | 路径        | 说明       | 请求参数           | 响应                                                              |
| ---- | ----------- | ---------- | ------------------ | ----------------------------------------------------------------- |
| GET  | `/charging` | 充电统计   | startDate, endDate | ChargingStatisticsVO (total_sessions, total_energy, avg_duration) |
| GET  | `/revenue`  | 收入统计   | startDate, endDate | RevenueStatisticsVO (total_revenue, charging_fee, service_fee)    |
| GET  | `/stations` | 充电站统计 | startDate, endDate | List<StationStatisticsVO>                                         |

### 5.7 物联网网关服务 (IoT Gateway Service)
**Base URL**: `/iot`

| 方法 | 路径                    | 说明             | 请求参数                                                 | 响应         |
| ---- | ----------------------- | ---------------- | -------------------------------------------------------- | ------------ |
| POST | `/data`                 | 接收设备数据     | DeviceDataDTO (deviceCode, dataType, payload, timestamp) | Boolean      |
| POST | `/command/{deviceCode}` | 发送设备指令     | deviceCode, command, params                              | Boolean      |
| GET  | `/online/{deviceCode}`  | 检查设备在线状态 | deviceCode                                               | Boolean      |
| GET  | `/devices/{id}/shadow`  | 获取设备影子     | deviceId                                                 | DeviceShadow |

---

## 6. BFF 层接口

### 6.1 用户端 BFF (Consumer BFF)
**Base URL**: `/consumer`

| 方法 | 路径                         | 说明           | 请求参数                    | 响应                           |
| ---- | ---------------------------- | -------------- | --------------------------- | ------------------------------ |
| GET  | `/nearby-stations`           | 查找附近充电站 | latitude, longitude, radius | List<Station>                  |
| GET  | `/home/{userId}`             | 获取用户首页   | userId                      | { memberInfo, recentSessions } |
| POST | `/charging/start`            | 启动充电       | StartChargingDTO            | ChargingSession                |
| POST | `/charging/{sessionId}/stop` | 停止充电       | sessionId                   | ChargingSession                |

### 6.2 管理端 BFF (Admin BFF)
**Base URL**: `/admin`

| 方法 | 路径                           | 说明                 | 请求参数           | 响应                                          |
| ---- | ------------------------------ | -------------------- | ------------------ | --------------------------------------------- |
| GET  | `/dashboard`                   | 获取仪表盘数据       | startDate, endDate | { chargingStats, revenueStats, stationStats } |
| GET  | `/stations/{stationId}/detail` | 获取充电站详情及设备 | stationId          | { station, devices }                          |

### 6.3 运营端 BFF (Operator BFF)
**Base URL**: `/operator`

| 方法 | 路径                       | 说明           | 请求参数            | 响应                                     |
| ---- | -------------------------- | -------------- | ------------------- | ---------------------------------------- |
| GET  | `/workbench/{operatorId}`  | 获取工作台数据 | operatorId          | { myOrders, pendingOrders, deviceStats } |
| POST | `/orders/{orderId}/accept` | 接单           | orderId, operatorId | Boolean                                  |

### 6.4 厂商端 BFF (OEM BFF)
**Base URL**: `/oem`

| 方法 | 路径                                     | 说明             | 请求参数            | 响应         |
| ---- | ---------------------------------------- | ---------------- | ------------------- | ------------ |
| POST | `/devices/register`                      | 注册设备         | DeviceRegisterDTO   | Device       |
| GET  | `/devices/manufacturer/{manufacturerId}` | 获取厂商设备列表 | manufacturerId      | List<Device> |
| POST | `/devices/{deviceCode}/control`          | 远程控制设备     | deviceCode, command | Boolean      |

### 6.5 电力公司 BFF (Utility BFF)
**Base URL**: `/utility`

| 方法 | 路径                   | 说明             | 请求参数            | 响应                               |
| ---- | ---------------------- | ---------------- | ------------------- | ---------------------------------- |
| POST | `/dr-events`           | 创建需求响应事件 | CreateEventDTO      | DemandResponseEvent                |
| GET  | `/dr-overview`         | 获取需求响应概览 | -                   | { activeEvents, availableDevices } |
| POST | `/settlements`         | 创建结算单       | CreateSettlementDTO | SettlementOrder                    |
| GET  | `/settlements/pending` | 获取待结算列表   | -                   | List<SettlementOrder>              |

---

## 7. 数据服务接口

### 7.1 搜索服务 (Search Service)

#### 7.1.1 充电站搜索
**Base URL**: `/search/stations`

| 方法 | 路径        | 说明           | 请求参数                                             | 响应                  |
| ---- | ----------- | -------------- | ---------------------------------------------------- | --------------------- |
| GET  | `/keyword`  | 全文搜索充电站 | keyword, pageNum, pageSize                           | List<StationSearchVO> |
| GET  | `/nearby`   | 附近充电站搜索 | latitude, longitude, radius, pageSize                | List<StationSearchVO> |
| GET  | `/advanced` | 高级筛选搜索   | keyword, operatorName, minAvailableDevices, pageSize | List<StationSearchVO> |

#### 7.1.2 充电会话搜索
**Base URL**: `/search/sessions`

| 方法 | 路径                   | 说明             | 请求参数                              | 响应                  |
| ---- | ---------------------- | ---------------- | ------------------------------------- | --------------------- |
| GET  | `/{sessionId}`         | 根据会话ID搜索   | sessionId                             | SessionSearchVO       |
| GET  | `/user/{userId}`       | 根据用户ID搜索   | userId, pageNum, pageSize             | List<SessionSearchVO> |
| GET  | `/station/{stationId}` | 根据充电站ID搜索 | stationId, status, pageNum, pageSize  | List<SessionSearchVO> |
| GET  | `/timerange`           | 按时间范围搜索   | startTime, endTime, pageNum, pageSize | List<SessionSearchVO> |

### 7.2 数据同步服务 (Data Sync Service)
**Base URL**: `/sync`

| 方法 | 路径                    | 说明                     | 请求参数  | 响应 |
| ---- | ----------------------- | ------------------------ | --------- | ---- |
| POST | `/stations/full`        | 手动触发充电站全量同步   | -         | void |
| POST | `/stations/{stationId}` | 手动触发充电站增量同步   | stationId | void |
| POST | `/sessions/recent`      | 手动触发充电会话增量同步 | -         | void |
| POST | `/sessions/{sessionId}` | 手动触发单个会话同步     | sessionId | void |

---

## 8. 实时通道（WebSocket/SSE）
- 主题：charging_status_update、connector_status_change、price_update、alarm_event、dr_command。
- 鉴权：连接时携带 token；心跳/超时；服务端按租户/角色路由。

---

## 9. 版本与灰度
- Header: X-Version；API Gateway 进行版本路由。
- 新旧协议双栈，设定弃用日期；灰度与金丝雀发布。

---

## 10. 接口调用说明

### 10.1 通用请求头
```
Authorization: Bearer <access_token>
X-Trace-Id: <uuid>
Content-Type: application/json
Idempotency-Key: <uuid>  // 幂等性保证，关键写接口必须
X-Version: v1  // API 版本控制
```

### 10.2 通用响应格式
```json
{
  "code": 0,
  "message": "success",
  "data": {},
  "timestamp": "2026-01-21T10:30:00Z",
  "traceId": "uuid"
}
```

### 10.3 分页响应格式
```json
{
  "code": 0,
  "data": {
    "records": [],
    "total": 100,
    "size": 20,
    "current": 1,
    "pages": 5
  }
}
```
