# Nova-X 数据设计文档（摘录）

## 1. 分区与分片策略
- 交易/订单/会话：按地域 + 月/季分表，单表行数控制 5-8 百万。
- 站点/设备：按地域分库；设备静态信息与状态流分离。
- 时序数据：按设备分区 + 时间窗口分片（TSDB），热数据 7 天，冷数据落湖。

## 2. 核心实体表（OLTP）
- user（账户）、vehicle、station、charger、connector、charging_session、pricing_rule、billing_item、settlement_order、payment_record、dr_order、vpp_resource、work_order。
- 关键索引示例：
  - user(phone)
  - station(geohash 索引)
  - connector(status, station_id)
  - charging_session(connector_id, start_time)
  - payment_record(trace_id)
  - settlement_order(biz_date, region)

## 3. 状态与事件流
- 设备状态流：device_status(topic) → TSDB + ES 近实时查询。
- 订单事件流：order_event(topic) → 计费/清结算/风控。
- 告警流：alarm_event(topic) → 告警中心 + 工单。

## 4. 缓存设计
- Key 模板与 TTL：
  - session:${sessionId}，ttl=2h
  - station:${stationId}:snapshot，ttl=10s
  - pricing:${stationId}:${period}，ttl=30m（预热）
  - token:${userId}，ttl=24h
- 热点保护：本地缓存 + 限流 + 随机过期抖动。

## 5. 幂等与对账字段
- trace_id、idempotent_key、biz_date、partition_key(region, date)、version（乐观锁）、checksum。

## 6. 枚举与状态机
- charging_session.status：pending/active/stopped/settling/closed/abnormal。
- payment.status：init/authorized/success/refund/failed。
- connector.status：idle/charging/fault/disabled/reserved。

## 7. 数据生命周期
- OLTP 数据在线 6-12 个月，冷归档至数据湖。
- 日志与指标：热存 30 天，冷存 180 天以上。
- 个人敏感字段：加密存储，定期脱敏导出。
