# Nova-X 全球智能能源基础设施平台 —— 架构设计文档

## 文档信息
- 项目名称：Nova-X (星云) 全球智能能源基础设施与微电网调度平台
- 文档版本：v1.0
- 创建日期：2026-01-20
- 关联文档：项目背景书、需求描述文档

---

## 1. 架构目标与原则
- 对齐业务：支持充电找桩、智能调度、清结算、DR/VPP、多角色运营。
- 高可靠：SLA 99.99%，RPO ≤ 1 分钟，RTO ≤ 5 分钟，异地多活。
- 高性能：核心链路 ≥ 50,000 TPS，关键指令端到端延迟 ≤ 500ms。
- 可扩展：微服务 + 事件驱动，分区分片，弹性伸缩，多协议接入。
- 安全合规：PCI DSS、数据加密、最小权限、审计可追溯。
- 多端一致：Web/小程序/APP 三端一致体验与网关策略。

---

## 2. 整体架构概览
- **多端接入层**：Web、微信/支付宝/抖音/百度小程序、iOS/Android APP；统一网关接入（HTTPS + WAF），静态资源 CDN。
- **边缘接入与 IoT 层**：多协议接入网关（OCPP 1.6/2.0、GB/T、MQTT/CoAP），边缘节点（缓存、指令快速下发、局部容灾），设备影子与数字孪生。
- **网关与 BFF 层**：API Gateway（鉴权、流控、灰度、签名、协议转换）；BFF 拆分：C 端、运营商、OEM、Utilities、Admin，三端适配（Web/小程序/APP）。
- **业务微服务层**：账户与身份、设备管理、站点管理、订单与会话、计费与清结算、定价与促销、调度与 DR/VPP、支付、会员积分、工单与运维、通知、报表。
- **调度与算法层**：有序充电、功率分配、拥堵预测、路径规划、负荷预测、VPP 聚合与竞价、DR 指令执行与评估。
- **数据与存储层**：
  - OLTP：分库分表 MySQL/PostgreSQL（按地域+时间分片）。
  - 缓存：Redis Cluster（Session、热点桩态、价目、令牌）。
  - 时序：InfluxDB/TimescaleDB（设备指标、功率、电流、电压）。
  - 文档/对象：MongoDB + 对象存储（S3/HDFS）。
  - 搜索：Elasticsearch（站点搜索、日志检索）。
  - 数据湖/仓库：HDFS/S3 + Hive/ClickHouse，实时计算 Flink，离线计算 Spark。
- **消息与事件总线**：Kafka/RocketMQ（订单事件、状态上报、告警、结算流水、DR 指令、OTA 任务）。
- **Observability**：Prometheus + Grafana，ELK/Loki，SkyWalking/Jaeger，全链路日志与指标；告警中心。
- **运维与交付**：Kubernetes + Istio，CI/CD（GitHub Actions/GitLab CI），配置中心、服务注册、灰度/蓝绿、自动扩缩容。

---

## 3. 模块设计

### 3.1 接入与 BFF
- **API Gateway**：TLS 1.3，JWT/OAuth2，签名校验，限流、熔断、重试，灰度路由，多区域就近访问。
- **BFF 分层**：
  - C 端（APP/小程序）：地图找桩、订单、支付、消息。
  - 运营商 Web：站点/设备/定价/财务/看板。
  - OEM Web：固件、诊断、工单、日志。
  - Utilities Web：DR 指令、负荷监控、VPP 资源。
  - Admin Web：全局监控、权限、审计、报表。

### 3.2 核心业务微服务
- **账户与权限**：用户、组织、角色、RBAC、MFA、审计日志。
- **站点与设备元数据**：
  - **站点管理**：站点基本信息、地理位置、设施配置。
  - **设备元数据**：充电桩档案（静态）、型号规格、配置参数、资产信息。
  - **设备状态网关**：实时状态上报（动态）、设备影子同步、OTA 任务推送、指令下发队列。
- **订单与会话**：扫码/编号启动、会话生命周期、状态机、异常补偿、对账标签。
- **计费与清结算**：实时计价、分时/动态定价、分账引擎、多币种、多税率、对账与发票。
- **支付网关**：微信/支付宝/卡/Apple Pay/Google Pay，预授权/扣款/退款，对账单拉取。
- **调度与 DR/VPP**：功率分配、有序充电、DR 执行、VPP 聚合与竞价、补偿计算。
- **会员与营销**：优惠券、积分、会员等级、活动灰度。
- **运营与运维**：告警、工单、巡检、备件、SLA 指标。
- **通知中心**：模板、站内信、短信、邮件、Push，幂等与重试。
- **报表与 BI**：多维数据集，预聚合，订阅与导出。

### 3.3 IoT 与边缘
- 多协议适配插件化；OCPP/GB/T 解析器；指令优先级队列；断点续传；影子同步；
- 边缘节点：本地队列、弱网缓存、就近控制、局部安全策略；
- 安全：设备证书、双向 TLS、签名、防重放；
- 延迟要求：启动/停止指令链路 ≤ 500ms；状态心跳 5s 周期。

### 3.4 数据与一致性
- **强一致路径**：支付与启桩、停桩与结算，采用事务消息 + 幂等表 + 补偿任务（TCC/可靠事件）。
- **最终一致路径**：告警、看板统计、积分、营销，事件驱动异步处理。
- **幂等设计**：业务幂等键、去重表、消息有序/去重、接口重试安全。

### 3.5 事件驱动架构（解耦核心）
**设计原则**：通过 Kafka 事件总线解耦微服务间的同步调用，避免长链路依赖。

**事件主题**：
- `account-events`：用户注册、认证、权限变更 → 会员服务、通知服务消费。
- `device-events`：设备上线/离线/故障 → 监控服务、工单服务消费。
- `session-events`：会话启动/停止/完成 → 计费、支付、通知服务异步处理。
- `billing-events`：账单生成 → 结算服务、报表服务消费。
- `payment-events`：支付成功/失败 → 订单服务、会员积分服务消费。
- `notification-events`：通知发送请求 → 短信/邮件/Push 网关异步发送。

**关键链路优化**：
```
原始设计（同步调用链）：
session-service → account-service → pricing-service → billing-service
  → settlement-service → payment-service → notification-service
问题：7 个服务串联，任意一个故障导致整条链路失败。

优化后（事件驱动）：
session-service 发送 `session-started` 事件 → Kafka
  └─ billing-service 异步消费 → 计算费用
  └─ notification-service 异步消费 → 发送通知
  └─ report-service 异步消费 → 统计数据

session-service 发送 `session-completed` 事件 → Kafka
  └─ billing-service 封账 → 发送 `billing-completed` 事件
  └─ settlement-service 消费 `billing-completed` → 分账
  └─ payment-service 消费 `billing-completed` → 扣款
  └─ member-service 消费 `payment-success` → 积分

优势：
1. 服务间解耦，互不感知
2. 异步处理，提升吞吐量
3. 容错能力，单服务故障不影响整体
4. 水平扩展，增加消费者即可
```

---

## 4. 数据流与时序（关键链路）

### 4.1 扫码启充
1) APP/小程序扫码 → BFF → 账户鉴权、风控 → 预授权/预扣费。
2) 订单服务创建会话，写事务消息 → Kafka。
3) 调度服务计算功率 → IoT 网关下发启动指令 → 桩确认。
4) 状态回传（<500ms），订单会话更新；失败触发补偿（退款/重试/人工介入）。

### 4.2 计费与结算
1) 时序数据上报（功率/电量/电价）→ 计费服务实时累算。
2) 结束事件 → 计费封账 → 分账服务拆分（平台/场站/电网/第三方）。
3) 清结算服务对账（支付渠道、内部账、设备抄表），异常单挂起复核。

### 4.3 需求响应 / 有序充电
1) Utilities 发布 DR 指令 → DR 服务生成策略 → 调度服务下发功率限制。
2) 各站点边缘/桩端执行功率调整 → 回传执行结果 → 评估与补偿计算。

---

## 5. 存储与分片策略
- **分库分表**：按地域（国家/大区）+ 时间（月/季度）分片，避免跨洲长链路；热点表（订单、会话、状态流）做水平分表。
- **缓存策略**：站点/桩态 5-10s 过期；价目表按时段预热；Token/Session 分布式缓存；热点保护与本地缓存。
- **时序与冷热分层**：近 7 天热数据（TSDB + Redis）；历史冷数据落湖，按需回溯。
- **归档与压缩**：时序压缩（Gorilla/Delta），日志生命周期管理，定期归档。

---

## 6. 性能与容量规划
- **前端**：CDN、HTTP/2、GZIP/Brotli、图片/地图瓦片缓存、懒加载；小程序/APP 关键路径 ≤ 2s。
- **后端**：
  - 网关：多活集群，单集群 50k+ RPS，限流/降级。
  - 服务：无状态优先，自动扩缩容，连接池隔离，批处理与异步化。
  - 数据库：主从/多主，读写分离，连接池限流；慢查询告警。
  - 消息队列：分区扩展，顺序主题用于关键指令，重试/死信队列。
- **IoT 指令链路**：优先级队列，超时重试，ACK 校验；边缘直连降延迟。

---

## 7. 安全与合规
- 传输：TLS 1.3，HSTS，双向 TLS（设备侧）。
- 认证授权：OAuth2/OIDC，MFA（管理端），RBAC/ABAC，临时令牌最小权限。
- 数据安全：AES-256 存储加密，字段级脱敏，密钥托管（KMS），审计日志不可篡改。
- 支付安全：PCI DSS，风控（设备指纹、行为评分），大额二次确认。
- 设备安全：证书绑定、签名、固件哈希校验、OTA 灰度与回滚。
- 隐私与合规：GDPR/本地法规，多区域数据边界，访问留痕。

---

## 8. 高可用与容灾
- 部署：多地域多活，流量就近，跨域容灾级联；关键服务双 AZ 部署。
- 数据：跨机房同步，异步跨洲复制；Binlog 流转湖；RPO ≤ 1 分钟。
- 故障演练：故障注入（网络/节点/依赖），应急预案、演练手册。
- 降级策略：
  - 找桩读缓存，非关键字段降级。
  - 支付失败回退多通道；指令下发失败退回队列重试。
  - DR/功率策略本地兜底；地图/推荐降级为静态。

---

## 9. 观测性与运维
- **指标**：QPS/TPS、延迟、错误率、SLA、设备在线率、指令成功率、DR 响应率。
- **日志**：结构化日志，TraceID 贯穿，采样率动态调节。
- **追踪**：全链路追踪覆盖网关、BFF、服务、队列、DB、IoT。
- **告警**：多级告警（P0-P3），多通道推送；SLO 违约预警。
- **发布**：灰度/蓝绿，自动回滚，健康检查与熔断；配置热更新。

---

## 10. 数据治理与模型
- **数据总线**：事件 Schema 注册，版本兼容；数据质量校验。
- **主题划分**：设备状态流、订单事件流、计费流、告警流、DR/VPP 流。
- **数据权限**：分域分级，行列级权限，脱敏视图。
- **机器学习**：
  - 负荷预测、拥堵预测、功率分配优化、路径推荐。
  - 特征计算：Flink 实时 + Spark 离线；模型服务化（在线推理服务）。

---

## 11. 前端架构（Web/小程序/APP）
- **Web**：React/Vue3 + TypeScript，微前端（子应用：运营商、OEM、Utilities、Admin），SSR/CSR 结合；AntD/ElementPlus；ECharts/Mapbox。
- **小程序**：Taro/uni-app 统一多端；模块化包拆分，离线缓存；地图 SDK（高德/腾讯）。
- **APP**：Flutter/React Native；模块化路由；离线包与热更新（合规区域启用）；Push（Firebase/JPush）。
- **BFF 协议**：REST/GraphQL（读多写少场景可选）；WebSocket/SSE 用于实时状态/告警；统一错误码与签名。

---

## 12. 部署与环境
- 环境：dev / test / pre / prod，多地域 prod 集群；配置隔离。
- 交付：CI/CD 自动化构建、静态扫描、安全扫描、单元/集成测试、金丝雀发布。
- 基础设施：Kubernetes + Istio，Helm/ArgoCD 部署；Stateful 服务独立存储卷。

---

## 13. 迁移与演进
- **阶段交付对齐需求文档**：
  - MVP：核心充电流程、OCPP 1.6、支付、基础站点/设备管理。
  - 增强：智能推荐、动态定价、会员、数据看板、多协议。
  - 智能调度：有序充电、DR/VPP、负荷预测。
  - 全球化：多语言/多币种、异地多活、安全加固。
- **演进路径**：单体风险拆分 → 微服务 → 事件驱动 → 多活与边缘优化；持续容量测试。

---

## 14. 风险与缓解
- 高并发与热点：热点键打散、读写隔离、缓存保护、队列削峰、优先级队列。
- 一致性风险：事务消息 + 幂等 + 补偿，关键路径同步；对账差异挂账。
- 设备异构：协议插件、模拟器、兼容性测试、灰度升级。
- 安全合规：定期渗透、依赖漏洞扫描、密钥轮换、最小权限审计。
- 观测盲区：全链路追踪覆盖 IoT，黑盒/白盒探针，SLO 看板。

---

## 15. 开放接口与集成
- API 规范：RESTful / WebSocket；统一前缀 /api/v1；分页、签名、时区/货币头。
- 三方集成：地图、支付、短信、邮件、Push、身份（OIDC）、日志/监控外部汇聚。
- SDK：Web/小程序/APP SDK 提供鉴权、签名、重试、日志上报封装。

---

## 16. 验收与度量
- **性能**：QPS/TPS、P95/P99 延迟、指令成功率、缓存命中率。
- **可靠性**：SLA、故障恢复时长、演练通过率。
- **安全**：渗透测试通过率、漏洞修复时长、密钥轮换合规性。
- **业务**：启充成功率、计费准确率、DR 响应达成率、VPP 收益准确率。
- **前端体验**：首屏/关键路径耗时、崩溃率、错误率。
